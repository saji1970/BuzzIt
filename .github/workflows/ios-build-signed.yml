name: Build iOS App (With Code Signing)

on:
  workflow_dispatch:  # Manual trigger only (requires secrets)
    inputs:
      export_method:
        description: 'Export method'
        required: true
        default: 'ad-hoc'
        type: choice
        options:
        - ad-hoc
        - development
        - enterprise
        - app-store

jobs:
  build-ios-signed:
    name: Build Signed iOS App
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: BuzzIt/package-lock.json
    
    - name: ðŸ“± Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: ðŸ” Setup Code Signing
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
        p12-password: ${{ secrets.IOS_P12_PASSWORD }}
    
    - name: ðŸ“‹ Install Provisioning Profile
      uses: apple-actions/download-provisioning-profiles@v1
      with:
        bundle-id: 'com.buzzit.app'
        issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
        api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
    
    - name: ðŸ”§ Install dependencies
      working-directory: ./BuzzIt
      run: |
        npm ci
    
    - name: ðŸ’Ž Install CocoaPods
      run: |
        sudo gem install cocoapods
    
    - name: ðŸ“š Install Pods
      working-directory: ./BuzzIt/ios
      run: |
        pod install --repo-update
    
    - name: ðŸ§¹ Clean build
      working-directory: ./BuzzIt/ios
      run: |
        xcodebuild clean \
          -workspace Buzzit.xcworkspace \
          -scheme Buzzit
    
    - name: ðŸ“¦ Build Archive
      working-directory: ./BuzzIt/ios
      env:
        EXPORT_METHOD: ${{ github.event.inputs.export_method }}
      run: |
        xcodebuild archive \
          -workspace Buzzit.xcworkspace \
          -scheme Buzzit \
          -configuration Release \
          -archivePath build/Buzzit.xcarchive \
          -allowProvisioningUpdates
    
    - name: ðŸ“¤ Export IPA
      working-directory: ./BuzzIt/ios
      env:
        EXPORT_METHOD: ${{ github.event.inputs.export_method }}
      run: |
        # Create export options dynamically
        cat > ExportOptions-${EXPORT_METHOD}.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>${EXPORT_METHOD}</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath build/Buzzit.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist ExportOptions-${EXPORT_METHOD}.plist \
          -allowProvisioningUpdates
    
    - name: ðŸ“± Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-signed
        path: BuzzIt/ios/build/ipa/*.ipa
        retention-days: 30
    
    - name: âœ… Build Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ Signed iOS Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Export Method:** ${{ github.event.inputs.export_method }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Signed IPA: Check artifacts below" >> $GITHUB_STEP_SUMMARY

