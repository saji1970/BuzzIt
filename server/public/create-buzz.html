<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Buzz - BuzzIt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .user-info span {
            color: #666;
            font-weight: 500;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #fff;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #667eea;
            color: white;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .buzz-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .buzz-type-btn {
            padding: 15px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .buzz-type-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .buzz-type-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group textarea:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .char-counter {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #ff9800;
        }

        .char-counter.error {
            color: #f44336;
        }

        .interests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .interest-chip {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
        }

        .interest-chip:hover {
            border-color: #667eea;
        }

        .interest-chip.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .media-upload {
            border: 2px dashed #e1e5e9;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .media-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .media-upload.has-file {
            border-style: solid;
            border-color: #667eea;
        }

        .media-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
        }

        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .poll-option-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .poll-option-row input {
            flex: 1;
        }

        .btn-remove {
            padding: 8px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-add {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .social-platforms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .social-platform {
            padding: 12px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .social-platform:hover {
            border-color: #667eea;
        }

        .social-platform.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .social-platform.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .social-platform input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none !important;
        }

        .location-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-top: 10px;
        }

        .location-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .location-item:hover {
            background: #f8f9fa;
        }

        .location-item:last-child {
            border-bottom: none;
        }

        .selected-location {
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêù Create Buzz</h1>
            <div class="user-info">
                <span id="username-display"></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="card">
            <div class="section-title">Buzz Type</div>
            <div class="buzz-types">
                <button class="buzz-type-btn" data-type="gossip">üí¨ Gossip</button>
                <button class="buzz-type-btn" data-type="thought">üí≠ Just a Thought</button>
                <button class="buzz-type-btn" data-type="event">üìÖ Event</button>
                <button class="buzz-type-btn" data-type="poll">üìä Poll</button>
            </div>
        </div>

        <div class="card">
            <div class="form-group">
                <label for="content">What's buzzing? *</label>
                <textarea id="content" placeholder="Share your buzz..." maxlength="500"></textarea>
                <div class="char-counter" id="char-counter">0/500</div>
            </div>
        </div>

        <div class="card" id="event-fields" class="hidden">
            <div class="section-title">Event Details</div>
            <div class="form-group">
                <label for="event-date">Event Date & Time *</label>
                <input type="datetime-local" id="event-date">
            </div>
            <div class="form-group">
                <label for="location-search">Location</label>
                <input type="text" id="location-search" placeholder="Search for a location...">
                <button type="button" class="btn-add" onclick="useMyLocation()">üìç Use My Location</button>
                <div id="location-results" class="location-results hidden"></div>
                <div id="selected-location" class="hidden"></div>
            </div>
        </div>

        <div class="card" id="poll-fields" class="hidden">
            <div class="section-title">Poll Options</div>
            <div class="poll-options" id="poll-options">
                <div class="poll-option-row">
                    <input type="text" placeholder="Option 1" class="poll-option">
                </div>
                <div class="poll-option-row">
                    <input type="text" placeholder="Option 2" class="poll-option">
                </div>
            </div>
            <button type="button" class="btn-add" onclick="addPollOption()">+ Add Option</button>
        </div>

        <div class="card">
            <div class="section-title">Select Interests (at least 1 required) *</div>
            <div class="interests-grid" id="interests-grid"></div>
        </div>

        <div class="card">
            <div class="section-title">Add Media (optional)</div>
            <div class="media-upload" id="media-upload" onclick="document.getElementById('file-input').click()">
                <div id="upload-prompt">
                    <p style="font-size: 48px; margin-bottom: 10px;">üì∏</p>
                    <p style="font-weight: 600; margin-bottom: 5px;">Click to upload image or video</p>
                    <p style="font-size: 14px; color: #666;">Max size: 50MB</p>
                </div>
                <div id="upload-preview" class="hidden"></div>
                <div id="upload-progress" class="progress hidden">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
            <input type="file" id="file-input" accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <div class="card">
            <div class="section-title">Share to Social Media (optional)</div>
            <div class="social-platforms" id="social-platforms"></div>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                Not connected? <a href="social-settings.html" style="color: #667eea;">Manage social accounts</a>
            </p>
        </div>

        <button class="btn-submit" id="submit-btn" onclick="submitBuzz()">
            Create Buzz üöÄ
        </button>
    </div>

    <script>
        const API_URL = 'https://buzzit-production.up.railway.app';
        let authToken = null;
        let currentUser = null;
        let selectedBuzzType = null;
        let selectedInterests = [];
        let selectedLocation = null;
        let uploadedMedia = null;
        let selectedSocialPlatforms = [];
        let connectedAccounts = [];

        // Interests data (from mobile app)
        const interests = [
            { id: '1', name: 'Technology', emoji: 'üíª' },
            { id: '2', name: 'Music', emoji: 'üéµ' },
            { id: '3', name: 'Sports', emoji: '‚öΩ' },
            { id: '4', name: 'Fashion', emoji: 'üëó' },
            { id: '5', name: 'Food', emoji: 'üçï' },
            { id: '6', name: 'Travel', emoji: '‚úàÔ∏è' },
            { id: '7', name: 'Gaming', emoji: 'üéÆ' },
            { id: '8', name: 'Art', emoji: 'üé®' },
            { id: '9', name: 'Fitness', emoji: 'üí™' },
            { id: '10', name: 'Movies', emoji: 'üé¨' },
            { id: '11', name: 'Books', emoji: 'üìö' },
            { id: '12', name: 'Photography', emoji: 'üì∏' },
            { id: '13', name: 'Politics', emoji: 'üèõÔ∏è' }
        ];

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initializeBuzzTypes();
            initializeInterests();
            initializeCharCounter();
            initializeLocationSearch();
            fetchConnectedAccounts();
        });

        function checkAuth() {
            authToken = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');

            if (!authToken || !userStr) {
                window.location.href = 'user-login.html';
                return;
            }

            try {
                currentUser = JSON.parse(userStr);
                document.getElementById('username-display').textContent = currentUser.username || currentUser.displayName;
            } catch (error) {
                console.error('Failed to parse user:', error);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = 'user-login.html';
        }

        function initializeBuzzTypes() {
            const buttons = document.querySelectorAll('.buzz-type-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedBuzzType = btn.dataset.type;
                    updateConditionalFields();
                });
            });
        }

        function updateConditionalFields() {
            const eventFields = document.getElementById('event-fields');
            const pollFields = document.getElementById('poll-fields');

            eventFields.classList.toggle('hidden', selectedBuzzType !== 'event');
            pollFields.classList.toggle('hidden', selectedBuzzType !== 'poll');
        }

        function initializeInterests() {
            const grid = document.getElementById('interests-grid');
            interests.forEach(interest => {
                const chip = document.createElement('div');
                chip.className = 'interest-chip';
                chip.textContent = `${interest.emoji} ${interest.name}`;
                chip.dataset.id = interest.id;
                chip.addEventListener('click', () => toggleInterest(interest, chip));
                grid.appendChild(chip);
            });
        }

        function toggleInterest(interest, element) {
            const index = selectedInterests.findIndex(i => i.id === interest.id);
            if (index > -1) {
                selectedInterests.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedInterests.push(interest);
                element.classList.add('selected');
            }
        }

        function initializeCharCounter() {
            const textarea = document.getElementById('content');
            const counter = document.getElementById('char-counter');

            textarea.addEventListener('input', () => {
                const length = textarea.value.length;
                counter.textContent = `${length}/500`;

                counter.classList.remove('warning', 'error');
                if (length > 450) counter.classList.add('warning');
                if (length >= 500) counter.classList.add('error');
            });
        }

        let locationSearchTimeout;
        function initializeLocationSearch() {
            const searchInput = document.getElementById('location-search');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(locationSearchTimeout);
                const query = e.target.value.trim();

                if (query.length < 3) {
                    document.getElementById('location-results').classList.add('hidden');
                    return;
                }

                locationSearchTimeout = setTimeout(() => searchLocation(query), 500);
            });
        }

        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();

                const resultsDiv = document.getElementById('location-results');
                resultsDiv.innerHTML = '';

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="location-item">No locations found</div>';
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'location-item';
                        item.textContent = result.display_name;
                        item.onclick = () => selectLocation(result);
                        resultsDiv.appendChild(item);
                    });
                }

                resultsDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Location search error:', error);
            }
        }

        function selectLocation(location) {
            selectedLocation = {
                latitude: parseFloat(location.lat),
                longitude: parseFloat(location.lon),
                address: location.display_name
            };

            document.getElementById('location-results').classList.add('hidden');
            const selectedDiv = document.getElementById('selected-location');
            selectedDiv.innerHTML = `
                <span>üìç ${location.display_name}</span>
                <button class="btn-remove" onclick="clearLocation()">Clear</button>
            `;
            selectedDiv.classList.remove('hidden');
        }

        function clearLocation() {
            selectedLocation = null;
            document.getElementById('selected-location').classList.add('hidden');
            document.getElementById('location-search').value = '';
        }

        function useMyLocation() {
            if (!navigator.geolocation) {
                showAlert('Geolocation is not supported by your browser', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();

                    selectLocation({
                        lat: latitude,
                        lon: longitude,
                        display_name: data.display_name
                    });
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    selectedLocation = { latitude, longitude };
                    showAlert('Location detected but could not get address', 'info');
                }
            }, (error) => {
                console.error('Geolocation error:', error);
                showAlert('Failed to get your location', 'error');
            });
        }

        function addPollOption() {
            const container = document.getElementById('poll-options');
            const currentOptions = container.querySelectorAll('.poll-option-row');

            if (currentOptions.length >= 10) {
                showAlert('Maximum 10 poll options allowed', 'error');
                return;
            }

            const row = document.createElement('div');
            row.className = 'poll-option-row';
            row.innerHTML = `
                <input type="text" placeholder="Option ${currentOptions.length + 1}" class="poll-option">
                <button class="btn-remove" onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(row);
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size
            if (file.size > 50 * 1024 * 1024) {
                showAlert('File size exceeds 50MB limit', 'error');
                return;
            }

            // Show preview
            const previewDiv = document.getElementById('upload-preview');
            const promptDiv = document.getElementById('upload-prompt');

            promptDiv.classList.add('hidden');
            previewDiv.classList.remove('hidden');
            previewDiv.innerHTML = '<p>Uploading...</p>';

            // Upload to Cloudinary
            await uploadMedia(file);
        }

        async function uploadMedia(file) {
            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            progressDiv.classList.remove('hidden');

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            uploadedMedia = response.data;
                            showMediaPreview(file, uploadedMedia);
                        } else {
                            showAlert('Upload failed: ' + (response.message || 'Unknown error'), 'error');
                            resetMediaUpload();
                        }
                    } else {
                        showAlert('Upload failed with status: ' + xhr.status, 'error');
                        resetMediaUpload();
                    }
                    progressDiv.classList.add('hidden');
                });

                xhr.addEventListener('error', () => {
                    showAlert('Upload failed. Please try again.', 'error');
                    resetMediaUpload();
                    progressDiv.classList.add('hidden');
                });

                xhr.open('POST', `${API_URL}/api/uploads`);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Upload failed: ' + error.message, 'error');
                resetMediaUpload();
                progressDiv.classList.add('hidden');
            }
        }

        function showMediaPreview(file, mediaData) {
            const previewDiv = document.getElementById('upload-preview');
            const isVideo = file.type.startsWith('video/');

            if (isVideo) {
                previewDiv.innerHTML = `
                    <video class="media-preview" controls>
                        <source src="${mediaData.url}" type="${file.type}">
                    </video>
                    <button class="btn-remove" onclick="resetMediaUpload()" style="margin-top: 10px;">Remove Media</button>
                `;
            } else {
                previewDiv.innerHTML = `
                    <img class="media-preview" src="${mediaData.url}" alt="Preview">
                    <button class="btn-remove" onclick="resetMediaUpload()" style="margin-top: 10px;">Remove Media</button>
                `;
            }

            document.getElementById('media-upload').classList.add('has-file');
        }

        function resetMediaUpload() {
            uploadedMedia = null;
            document.getElementById('upload-prompt').classList.remove('hidden');
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-preview').innerHTML = '';
            document.getElementById('media-upload').classList.remove('has-file');
            document.getElementById('file-input').value = '';
        }

        async function fetchConnectedAccounts() {
            try {
                const response = await fetch(`${API_URL}/api/social-auth/connected`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    connectedAccounts = data.accounts || [];
                    renderSocialPlatforms();
                }
            } catch (error) {
                console.error('Failed to fetch connected accounts:', error);
                renderSocialPlatforms();
            }
        }

        function renderSocialPlatforms() {
            const platforms = ['facebook', 'instagram', 'snapchat', 'twitter'];
            const container = document.getElementById('social-platforms');
            container.innerHTML = '';

            platforms.forEach(platform => {
                const isConnected = connectedAccounts.some(acc => acc.platform === platform && acc.is_connected);
                const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);

                const div = document.createElement('div');
                div.className = 'social-platform' + (isConnected ? '' : ' disabled');
                div.innerHTML = `
                    <input type="checkbox" id="social-${platform}" ${isConnected ? '' : 'disabled'}>
                    <label for="social-${platform}">${platformName}</label>
                `;

                if (isConnected) {
                    const checkbox = div.querySelector('input');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedSocialPlatforms.push(platform);
                            div.classList.add('selected');
                        } else {
                            selectedSocialPlatforms = selectedSocialPlatforms.filter(p => p !== platform);
                            div.classList.remove('selected');
                        }
                    });
                }

                container.appendChild(div);
            });
        }

        function validateBuzz() {
            const content = document.getElementById('content').value.trim();

            if (!selectedBuzzType) {
                showAlert('Please select a buzz type', 'error');
                return false;
            }

            if (!content || content.length === 0) {
                showAlert('Please enter some content', 'error');
                return false;
            }

            if (selectedInterests.length === 0) {
                showAlert('Please select at least one interest', 'error');
                return false;
            }

            if (selectedBuzzType === 'event') {
                const eventDate = document.getElementById('event-date').value;
                if (!eventDate) {
                    showAlert('Please select event date and time', 'error');
                    return false;
                }
            }

            if (selectedBuzzType === 'poll') {
                const pollOptions = Array.from(document.querySelectorAll('.poll-option'))
                    .map(input => input.value.trim())
                    .filter(val => val.length > 0);

                if (pollOptions.length < 2) {
                    showAlert('Please provide at least 2 poll options', 'error');
                    return false;
                }
            }

            return true;
        }

        async function submitBuzz() {
            if (!validateBuzz()) return;

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Buzz...';

            try {
                // Build buzz payload
                const payload = {
                    content: document.getElementById('content').value.trim(),
                    buzzType: selectedBuzzType,
                    interests: selectedInterests,
                    userId: currentUser.id,
                    username: currentUser.username || currentUser.displayName,
                    userAvatar: currentUser.avatar || null
                };

                // Add media if uploaded
                if (uploadedMedia) {
                    payload.media = {
                        type: uploadedMedia.mimeType.startsWith('video/') ? 'video' : 'image',
                        url: uploadedMedia.url,
                        mimeType: uploadedMedia.mimeType,
                        fileName: uploadedMedia.originalName
                    };
                }

                // Add event-specific fields
                if (selectedBuzzType === 'event') {
                    const eventDate = document.getElementById('event-date').value;
                    payload.eventDate = new Date(eventDate).toISOString();
                    if (selectedLocation) {
                        payload.location = selectedLocation;
                    }
                }

                // Add poll options
                if (selectedBuzzType === 'poll') {
                    const pollOptions = Array.from(document.querySelectorAll('.poll-option'))
                        .map((input, index) => ({
                            id: `option-${index + 1}`,
                            text: input.value.trim()
                        }))
                        .filter(opt => opt.text.length > 0);
                    payload.pollOptions = pollOptions;
                }

                // Create buzz
                const buzzResponse = await fetch(`${API_URL}/api/buzzes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const buzzData = await buzzResponse.json();

                if (!buzzData.success) {
                    throw new Error(buzzData.message || 'Failed to create buzz');
                }

                // Publish to social platforms if selected
                if (selectedSocialPlatforms.length > 0) {
                    await publishToSocialPlatforms(payload);
                }

                showAlert('Buzz created successfully! üéâ', 'success');
                setTimeout(() => {
                    resetForm();
                }, 2000);

            } catch (error) {
                console.error('Submit error:', error);
                showAlert('Failed to create buzz: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Buzz üöÄ';
            }
        }

        async function publishToSocialPlatforms(buzzPayload) {
            const socialPayload = {
                content: buzzPayload.content,
                mediaUrl: buzzPayload.media?.url,
                mediaType: buzzPayload.media?.type
            };

            const promises = selectedSocialPlatforms.map(async (platform) => {
                try {
                    const response = await fetch(`${API_URL}/api/social-share/${platform}/publish`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(socialPayload)
                    });

                    const data = await response.json();
                    return { platform, success: data.success };
                } catch (error) {
                    console.error(`Failed to publish to ${platform}:`, error);
                    return { platform, success: false };
                }
            });

            const results = await Promise.all(promises);
            const successCount = results.filter(r => r.success).length;

            if (successCount > 0) {
                showAlert(`Published to ${successCount} social platform(s)`, 'success');
            }
        }

        function resetForm() {
            // Reset buzz type
            selectedBuzzType = null;
            document.querySelectorAll('.buzz-type-btn').forEach(btn => btn.classList.remove('active'));

            // Reset content
            document.getElementById('content').value = '';
            document.getElementById('char-counter').textContent = '0/500';

            // Reset interests
            selectedInterests = [];
            document.querySelectorAll('.interest-chip').forEach(chip => chip.classList.remove('selected'));

            // Reset media
            resetMediaUpload();

            // Reset event fields
            document.getElementById('event-date').value = '';
            clearLocation();

            // Reset poll options
            const pollContainer = document.getElementById('poll-options');
            pollContainer.innerHTML = `
                <div class="poll-option-row">
                    <input type="text" placeholder="Option 1" class="poll-option">
                </div>
                <div class="poll-option-row">
                    <input type="text" placeholder="Option 2" class="poll-option">
                </div>
            `;

            // Reset social platforms
            selectedSocialPlatforms = [];
            document.querySelectorAll('.social-platform input').forEach(input => {
                input.checked = false;
            });
            document.querySelectorAll('.social-platform').forEach(div => div.classList.remove('selected'));

            // Hide conditional fields
            updateConditionalFields();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
