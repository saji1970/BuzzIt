<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BuzzIt Stream Test - Standalone App</title>
  <!-- Amazon IVS Web Broadcast SDK -->
  <script src="https://web-broadcast.live-video.net/1.6.0/amazon-ivs-web-broadcast.js"></script>
  <!-- Amazon IVS Player SDK -->
  <script src="https://player.live-video.net/1.46.0/amazon-ivs-player.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .status.loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status.ready {
      background: #d1fae5;
      color: #065f46;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status.broadcasting {
      background: #fee2e2;
      color: #dc2626;
      animation: pulse-bg 2s infinite;
    }

    @keyframes pulse-bg {
      0%, 100% { background: #fee2e2; }
      50% { background: #fecaca; }
    }

    .status-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status.loading .status-icon {
      background: #f59e0b;
    }

    .status.ready .status-icon {
      background: #10b981;
    }

    .status.error .status-icon {
      background: #ef4444;
    }

    .status.broadcasting .status-icon {
      background: #dc2626;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .video-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      z-index: 1;
    }

    .placeholder-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .placeholder-text {
      font-size: 1rem;
      opacity: 0.7;
    }

    .button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:active {
      transform: translateY(0);
    }

    .button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      opacity: 0.6;
    }

    .button.danger {
      background: #ef4444;
    }

    .button.danger:hover {
      background: #dc2626;
    }

    .button.success {
      background: #10b981;
    }

    .button.success:hover {
      background: #059669;
    }

    .playback-url-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      word-break: break-all;
    }

    .playback-url-display.hidden {
      display: none;
    }

    .playback-url-label {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .playback-url-value {
      font-size: 1rem;
      font-family: 'Courier New', monospace;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
    }

    .copy-btn {
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .copy-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      white-space: pre-line;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .hidden {
      display: none;
    }

    h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .user-info {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info span {
      font-weight: 600;
      color: #667eea;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 968px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìπ BuzzIt Stream Test</h1>
      <p>Create, broadcast, and preview live streams</p>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="card">
      <h2>üîê Login</h2>
      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" required placeholder="Enter your username">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required placeholder="Enter your password">
        </div>
        <button type="submit" class="button">Login</button>
      </form>
    </div>

    <!-- Main App Section (hidden until login) -->
    <div id="app-section" class="hidden">
      <div class="card">
        <div class="user-info">
          <div>
            Logged in as: <span id="user-display">-</span>
          </div>
          <button class="button danger" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="card">
        <div id="status" class="status loading">
          <div class="status-icon"></div>
          <span id="status-text">Initializing...</span>
        </div>

        <div id="error-message" class="error-message hidden"></div>

        <!-- Stream Creation Form -->
        <div id="stream-form-section">
          <h2>üìù Create Stream</h2>
          <form id="create-stream-form">
            <div class="form-group">
              <label for="stream-title">Stream Title *</label>
              <input type="text" id="stream-title" required placeholder="My Awesome Stream">
            </div>
            <div class="form-group">
              <label for="stream-description">Description</label>
              <textarea id="stream-description" placeholder="Describe your stream..."></textarea>
            </div>
            <div class="form-group">
              <label for="stream-category">Category</label>
              <select id="stream-category">
                <option value="entertainment">Entertainment</option>
                <option value="gaming">Gaming</option>
                <option value="music">Music</option>
                <option value="sports">Sports</option>
                <option value="tech">Technology</option>
                <option value="education">Education</option>
                <option value="other">Other</option>
              </select>
            </div>
            <button type="submit" class="button success">Create Stream & Start Broadcasting</button>
          </form>
        </div>

        <!-- Playback URL Display (shown after stream creation) -->
        <div id="playback-url-display" class="playback-url-display hidden">
          <div class="playback-url-label">üîó Playback URL</div>
          <div class="playback-url-value" id="playback-url-value">-</div>
          <button class="button copy-btn" onclick="copyPlaybackUrl()">üìã Copy URL</button>
        </div>

        <!-- Preview Section -->
        <div id="preview-section" class="hidden">
          <h2>üëÅÔ∏è Stream Preview</h2>
          <div class="video-container">
            <div id="player-placeholder" class="placeholder">
              <div class="placeholder-icon">üì∫</div>
              <div class="placeholder-text">Stream will appear here after broadcasting starts</div>
            </div>
            <video id="player-video" playsinline controls></video>
          </div>

          <div style="margin-bottom: 15px;">
            <button id="load-stream-btn" class="button" onclick="loadStream()" disabled>
              ‚ñ∂Ô∏è Load Stream
            </button>
            <button id="refresh-btn" class="button" onclick="refreshStream()">
              üîÑ Refresh
            </button>
            <button id="stop-broadcast-btn" class="button danger" onclick="stopBroadcast()" style="display: none;">
              ‚èπÔ∏è Stop Broadcast
            </button>
          </div>
        </div>
      </div>

      <!-- Camera/Broadcast Section -->
      <div class="card">
        <h2>üìπ Camera & Broadcast</h2>
        <div class="video-container">
          <div id="camera-placeholder" class="placeholder">
            <div class="placeholder-icon">üì∑</div>
            <div class="placeholder-text">Camera will start when you create a stream</div>
          </div>
          <video id="camera-video" autoplay muted playsinline></video>
        </div>

        <div style="margin-bottom: 15px;">
          <button id="start-camera-btn" class="button" onclick="startCamera()" disabled>
            üì∑ Start Camera
          </button>
          <button id="start-broadcast-btn" class="button success" onclick="startBroadcast()" disabled>
            üì° Start Broadcast
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin;
    let authToken = localStorage.getItem('userToken');
    let currentUser = null;
    let playbackUrl = '';
    let ingestUrl = '';
    let streamKey = '';
    let currentStream = null;

    // IVS Broadcast client
    let broadcastClient = null;
    let localStream = null;

    // IVS Player
    let player = null;
    let sdkLoaded = false;

    // Check SDK loading status
    function checkSDKStatus() {
      const broadcastSDKLoaded = typeof IVSBroadcastClient !== 'undefined';
      const playerSDKLoaded = typeof IVSPlayer !== 'undefined';
      
      console.log('SDK Status:', {
        broadcastSDK: broadcastSDKLoaded,
        playerSDK: playerSDKLoaded
      });

      if (broadcastSDKLoaded && playerSDKLoaded) {
        sdkLoaded = true;
        return true;
      }
      return false;
    }

    // Monitor SDK loading
    window.addEventListener('load', () => {
      // Check immediately
      if (checkSDKStatus()) {
        console.log('‚úÖ SDKs loaded on page load');
      } else {
        // Check periodically
        const checkInterval = setInterval(() => {
          if (checkSDKStatus()) {
            console.log('‚úÖ SDKs loaded after delay');
            clearInterval(checkInterval);
          }
        }, 500);

        // Stop checking after 10 seconds
        setTimeout(() => {
          clearInterval(checkInterval);
          if (!sdkLoaded) {
            console.warn('‚ö†Ô∏è SDKs may not be fully loaded');
          }
        }, 10000);
      }
    });

    // Check if already logged in
    if (authToken) {
      checkAuth();
    }

    // Login form handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success && data.token) {
          authToken = data.token;
          localStorage.setItem('userToken', authToken);
          currentUser = data.user;
          showApp();
        } else {
          showError(data.error || 'Login failed');
        }
      } catch (error) {
        showError(`Login error: ${error.message}`);
      }
    });

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/users/me`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const data = await response.json();
        if (data.success) {
          currentUser = data.data;
          showApp();
        } else {
          logout();
        }
      } catch (error) {
        logout();
      }
    }

    function showApp() {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('app-section').classList.remove('hidden');
      document.getElementById('user-display').textContent = currentUser?.username || currentUser?.displayName || 'User';
      init();
    }

    function logout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('userToken');
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('app-section').classList.add('hidden');
    }

    // Initialize app
    async function init() {
      try {
        updateStatus('loading', 'Loading configuration...');

        // Fetch configuration
        const configRes = await fetch(`${API_BASE_URL}/api/stream-test/config`);
        const config = await configRes.json();

        if (!config.hasConfig) {
          showError('IVS configuration is incomplete. Please check environment variables.');
          updateStatus('error', 'Configuration incomplete');
          return;
        }

        playbackUrl = config.playbackUrl;
        ingestUrl = config.ingestUrl;
        streamKey = config.streamKey;

        // Validate configuration
        if (!playbackUrl) {
          showError('Playback URL is missing. Please check IVS_PLAYBACK_URL environment variable.');
        }
        if (!ingestUrl) {
          showError('Ingest URL is missing. Please check IVS_INGEST_RTMPS_URL environment variable.');
        }
        if (!streamKey) {
          showError('Stream key is missing. Please check IVS_STREAM_KEY environment variable.');
        }

        // Check SDK status
        if (!checkSDKStatus()) {
          console.warn('‚ö†Ô∏è SDKs may not be fully loaded yet');
          updateStatus('ready', 'Ready! (SDKs loading...) Create a stream to begin.');
        } else {
          updateStatus('ready', 'Ready! Create a stream to begin.');
        }

        // Initialize IVS Player
        initializePlayer();

      } catch (error) {
        console.error('Initialization error:', error);
        showError(`Failed to initialize: ${error.message}`);
        updateStatus('error', 'Initialization failed');
      }
    }

    // Create stream form handler
    document.getElementById('create-stream-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!authToken) {
        showError('Please login first');
        return;
      }

      try {
        updateStatus('loading', 'Creating stream...');

        const title = document.getElementById('stream-title').value;
        const description = document.getElementById('stream-description').value;
        const category = document.getElementById('stream-category').value;

        const response = await fetch(`${API_BASE_URL}/api/live-streams`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ title, description, category })
        });

        const data = await response.json();

        if (data.success && data.data) {
          currentStream = data.data;
          
          // Use the stream's playback URL if available, otherwise use config
          const streamPlaybackUrl = currentStream.ivsPlaybackUrl || 
                                   currentStream.restreamPlaybackUrl || 
                                   currentStream.streamUrl || 
                                   playbackUrl;

          // Display playback URL prominently
          document.getElementById('playback-url-value').textContent = streamPlaybackUrl;
          document.getElementById('playback-url-display').classList.remove('hidden');

          // Show preview section
          document.getElementById('preview-section').classList.remove('hidden');
          document.getElementById('stream-form-section').style.display = 'none';

          // Enable camera button
          document.getElementById('start-camera-btn').disabled = false;

          updateStatus('ready', 'Stream created! Start camera to begin broadcasting.');
        } else {
          showError(data.error || 'Failed to create stream');
        }
      } catch (error) {
        console.error('Create stream error:', error);
        showError(`Failed to create stream: ${error.message}`);
      }
    });

    // Start camera
    async function startCamera() {
      try {
        updateStatus('loading', 'Requesting camera access...');

        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: true
        });

        const cameraVideo = document.getElementById('camera-video');
        cameraVideo.srcObject = localStream;

        document.getElementById('camera-placeholder').style.display = 'none';
        cameraVideo.style.display = 'block';

        document.getElementById('start-camera-btn').disabled = true;
        document.getElementById('start-broadcast-btn').disabled = false;

        updateStatus('ready', 'Camera ready! Click "Start Broadcast" to stream.');

      } catch (error) {
        console.error('Camera error:', error);
        showError(`Failed to access camera: ${error.message}\n\nPlease grant camera and microphone permissions.`);
      }
    }

    // Wait for SDK to load
    function waitForSDK(maxWait = 10000) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();
        const checkSDK = () => {
          if (typeof IVSBroadcastClient !== 'undefined' && IVSBroadcastClient.create) {
            console.log('‚úÖ IVS Broadcast SDK is ready');
            resolve();
          } else if (Date.now() - startTime > maxWait) {
            reject(new Error('IVS Web Broadcast SDK failed to load. Please refresh the page and check your internet connection.'));
          } else {
            setTimeout(checkSDK, 100);
          }
        };
        checkSDK();
      });
    }

    // Test network connectivity
    async function testNetworkConnectivity() {
      try {
        // Test if we can reach AWS IVS CDN
        const testUrl = 'https://web-broadcast.live-video.net/1.6.0/amazon-ivs-web-broadcast.js';
        const response = await fetch(testUrl, { method: 'HEAD', mode: 'no-cors' });
        return true;
      } catch (error) {
        console.warn('Network connectivity test failed:', error);
        return false;
      }
    }

    // Start broadcast
    async function startBroadcast() {
      if (!localStream) {
        showError('Please start the camera first');
        return;
      }

      if (!ingestUrl || !streamKey) {
        showError('IVS configuration is missing. Please check environment variables.');
        return;
      }

      try {
        updateStatus('loading', 'Checking SDK and network...');

        // Test network connectivity
        const networkOk = await testNetworkConnectivity();
        if (!networkOk) {
          console.warn('‚ö†Ô∏è Network connectivity test failed, but continuing...');
        }

        // Wait for SDK to be fully loaded
        await waitForSDK();

        updateStatus('loading', 'Initializing broadcast client...');

        // Check if IVS Web Broadcast SDK is loaded
        if (typeof IVSBroadcastClient === 'undefined') {
          throw new Error('IVS Web Broadcast SDK not loaded. Please refresh the page.');
        }

        // Validate ingest URL format
        if (!ingestUrl.startsWith('rtmp://') && !ingestUrl.startsWith('rtmps://')) {
          throw new Error(`Invalid ingest URL format: ${ingestUrl}. Must start with rtmp:// or rtmps://`);
        }

        console.log('üì° Creating broadcast client with:', {
          ingestUrl: ingestUrl.substring(0, 50) + '...',
          streamKeyLength: streamKey.length,
          hasLocalStream: !!localStream
        });

        // Create broadcast client
        broadcastClient = IVSBroadcastClient.create({
          streamConfig: IVSBroadcastClient.STANDARD_LANDSCAPE,
          ingestEndpoint: ingestUrl
        });

        updateStatus('loading', 'Adding video and audio devices...');

        // Add MediaStream to broadcast client
        try {
          broadcastClient.addVideoInputDevice(localStream, 'camera', { index: 0 });
          broadcastClient.addAudioInputDevice(localStream, 'mic');
          console.log('‚úÖ Devices added successfully');
        } catch (deviceError) {
          console.error('Device addition error:', deviceError);
          throw new Error(`Failed to add devices: ${deviceError.message}`);
        }

        updateStatus('loading', 'Starting broadcast to IVS...');
        console.log('üé¨ Starting broadcast with stream key...');

        // Start broadcasting with stream key
        try {
          await broadcastClient.startBroadcast(streamKey);
          console.log('‚úÖ Broadcast started successfully');
        } catch (broadcastError) {
          console.error('Broadcast start error:', broadcastError);
          // Clean up on error
          if (broadcastClient) {
            try {
              broadcastClient.delete();
            } catch (e) {
              console.error('Error cleaning up broadcast client:', e);
            }
            broadcastClient = null;
          }
          throw broadcastError;
        }

        updateStatus('broadcasting', 'üî¥ Broadcasting live to IVS!');

        document.getElementById('start-broadcast-btn').style.display = 'none';
        document.getElementById('stop-broadcast-btn').style.display = 'inline-flex';
        document.getElementById('load-stream-btn').disabled = false;

        // Auto-load player after 15 seconds
        setTimeout(() => {
          if (broadcastClient) {
            loadStream();
          }
        }, 15000);

      } catch (error) {
        console.error('Broadcast error:', error);
        const errorMessage = error.message || 'Unknown error';
        showError(`Failed to start broadcast: ${errorMessage}\n\n` +
          `Please check:\n` +
          `1. IVS credentials are correct\n` +
          `2. Ingest URL: ${ingestUrl ? 'Set' : 'Missing'}\n` +
          `3. Stream Key: ${streamKey ? 'Set' : 'Missing'}\n` +
          `4. Network connectivity to AWS IVS\n` +
          `5. Browser console for detailed errors`);
        updateStatus('error', 'Broadcast failed');
      }
    }

    // Stop broadcast
    async function stopBroadcast() {
      try {
        if (broadcastClient) {
          await broadcastClient.stopBroadcast();
          broadcastClient.delete();
          broadcastClient = null;
        }

        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }

        const cameraVideo = document.getElementById('camera-video');
        cameraVideo.srcObject = null;
        cameraVideo.style.display = 'none';
        document.getElementById('camera-placeholder').style.display = 'block';

        document.getElementById('start-camera-btn').disabled = false;
        document.getElementById('start-broadcast-btn').style.display = 'inline-flex';
        document.getElementById('start-broadcast-btn').disabled = true;
        document.getElementById('stop-broadcast-btn').style.display = 'none';

        updateStatus('ready', 'Broadcast stopped');

      } catch (error) {
        console.error('Stop broadcast error:', error);
        showError(`Error stopping broadcast: ${error.message}`);
      }
    }

    // Initialize Amazon IVS Player
    function initializePlayer() {
      if (!window.IVSPlayer || !window.IVSPlayer.isPlayerSupported) {
        showError('Amazon IVS Player is not supported in this browser.');
        return;
      }

      try {
        player = window.IVSPlayer.create();
        player.attachHTMLVideoElement(document.getElementById('player-video'));

        // Event listeners
        player.addEventListener(window.IVSPlayer.PlayerState.READY, () => {
          console.log('Player is ready');
          document.getElementById('player-placeholder').style.display = 'none';
          document.getElementById('player-video').style.display = 'block';
        });

        player.addEventListener(window.IVSPlayer.PlayerState.PLAYING, () => {
          console.log('Stream is playing');
          document.getElementById('player-placeholder').style.display = 'none';
          document.getElementById('player-video').style.display = 'block';
        });

        player.addEventListener(window.IVSPlayer.PlayerState.BUFFERING, () => {
          console.log('Stream is buffering');
        });

        player.addEventListener(window.IVSPlayer.PlayerState.IDLE, () => {
          console.log('Player is idle');
        });

        player.addEventListener(window.IVSPlayer.PlayerEventType.ERROR, (error) => {
          console.error('Player error:', error);
          if (error.code === 404 || error.type === 'ErrorNotAvailable') {
            showError(`Stream not available yet.\n\nWait 10-15 seconds after starting broadcast, then click "Refresh".`);
          } else {
            showError(`Player error: ${error.type || 'Unknown error'}`);
          }
        });

        console.log('Player initialized successfully');
      } catch (error) {
        console.error('Failed to initialize player:', error);
        showError(`Failed to initialize player: ${error.message}`);
      }
    }

    // Load stream
    function loadStream() {
      if (!player) {
        showError('Player not initialized');
        return;
      }

      const streamPlaybackUrl = currentStream?.ivsPlaybackUrl || 
                               currentStream?.restreamPlaybackUrl || 
                               currentStream?.streamUrl || 
                               playbackUrl;

      if (!streamPlaybackUrl) {
        showError('No playback URL available');
        return;
      }

      try {
        console.log('Loading stream:', streamPlaybackUrl);
        player.load(streamPlaybackUrl);
        player.play();
      } catch (error) {
        console.error('Failed to load stream:', error);
        showError(`Failed to load stream: ${error.message}`);
      }
    }

    // Refresh stream
    function refreshStream() {
      if (player) {
        player.pause();
        setTimeout(() => {
          loadStream();
        }, 500);
      }
    }

    // Copy playback URL
    function copyPlaybackUrl() {
      const url = document.getElementById('playback-url-value').textContent;
      navigator.clipboard.writeText(url).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        showError('Failed to copy URL');
      });
    }

    // Update status functions
    function updateStatus(type, message) {
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      statusEl.className = `status ${type}`;
      statusText.textContent = message;
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
      setTimeout(() => {
        errorEl.classList.add('hidden');
      }, 10000);
    }
  </script>
</body>
</html>
