# Facebook OAuth "Sorry, something went wrong" - Debug Guide

This generic error from Facebook can have multiple causes. Let's debug it step by step.

---

## Quick Diagnosis Steps

### Step 1: Check Your Server Logs

The most important step! Your server logs will tell you the exact error.

**If deployed to Railway:**
1. Go to Railway Dashboard
2. Select your backend service
3. Click on **"Deployments"**
4. Click on the latest deployment
5. Look at the logs for errors

**Look for errors like:**
- `invalid_request`
- `redirect_uri_mismatch`
- `invalid_client`
- `unauthorized_client`
- `access_denied`

**Common log patterns to search for:**
```
OAuth facebook callback error:
Facebook auth error:
Error:
invalid
mismatch
```

### Step 2: Verify Your Facebook App Settings

Check these in your Facebook App Dashboard:

1. **App is in the correct mode**
   - Top right corner: Should show "Development" or "Live"
   - If in Development mode, you must be added as a tester/developer

2. **Valid OAuth Redirect URIs are correct**
   - Go to: Facebook Login (or Facebook Login for Business) → Settings
   - Must include EXACT URLs (case-sensitive, no extra slashes):
     ```
     https://your-railway-domain.up.railway.app/oauth/callback/facebook
     https://your-railway-domain.up.railway.app/api/social-auth/oauth/facebook/callback
     ```

3. **App Domains are set**
   - Go to: Settings → Basic → App Domains
   - Add: `your-railway-domain.up.railway.app`

4. **Client OAuth Login is enabled**
   - Go to: Facebook Login → Settings
   - Set "Client OAuth Login" to **YES**
   - Set "Web OAuth Login" to **YES**

### Step 3: Check Environment Variables

Verify these are set in Railway:

```bash
FACEBOOK_CLIENT_ID=your_app_id
FACEBOOK_CLIENT_SECRET=your_app_secret
APP_BASE_URL=https://your-railway-domain.up.railway.app
```

**Optional (if using Facebook Login for Business):**
```bash
FACEBOOK_CONFIG_ID=your_config_id
```

---

## Common Causes and Solutions

### Cause 1: Redirect URI Mismatch

**Error in logs:** `redirect_uri_mismatch` or `invalid_redirect_uri`

**Why it happens:**
- The redirect URI in your OAuth request doesn't match what's configured in Facebook

**Solution:**

1. Check the OAuth URL being generated by your app
2. Look for the `redirect_uri` parameter
3. It should match EXACTLY what's in Facebook settings

**Check your code generates this:**
```
https://your-railway-domain.up.railway.app/oauth/callback/facebook
```

**Add to Facebook App Dashboard → Facebook Login → Settings → Valid OAuth Redirect URIs:**
```
https://your-railway-domain.up.railway.app/oauth/callback/facebook
https://your-railway-domain.up.railway.app/api/social-auth/oauth/facebook/callback
```

### Cause 2: App Not in Live Mode / You're Not a Tester

**Error in logs:** `unauthorized_client` or `access_denied`

**Why it happens:**
- App is in Development mode
- Your Facebook account is not added as a tester/developer

**Solution:**

**Option A: Add yourself as a tester**
1. Go to Facebook App Dashboard
2. Left sidebar → **Roles** → **Roles**
3. Under "Developers" or "Testers", click **Add**
4. Enter your Facebook account name
5. Send invitation
6. Accept the invitation in your Facebook notifications

**Option B: Add as Test User**
1. Left sidebar → **Roles** → **Test Users**
2. Click **"Add"** to create test users
3. Use those credentials to test

**Option C: Switch to Live Mode** (only if ready for production)
1. Complete all required settings
2. Submit for App Review if needed
3. Switch app to Live mode

### Cause 3: Invalid Client ID or Secret

**Error in logs:** `invalid_client` or `invalid_app_id`

**Why it happens:**
- Wrong Facebook App ID
- Wrong Facebook App Secret
- Environment variables not set correctly

**Solution:**

1. Go to Facebook App Dashboard → Settings → Basic
2. Copy your **App ID**
3. Click **Show** next to **App Secret** and copy it
4. Update Railway environment variables:
   ```
   FACEBOOK_CLIENT_ID=your_actual_app_id
   FACEBOOK_CLIENT_SECRET=your_actual_app_secret
   ```
5. Redeploy your app

### Cause 4: Missing Configuration ID (Facebook Login for Business)

**Error in logs:** `invalid_request` or `missing_configuration`

**Why it happens:**
- Your app uses Facebook Login for Business
- No config_id provided or invalid config_id

**Solution:**

1. Go to Facebook App Dashboard
2. Products → Facebook Login for Business → Configurations
3. Create a configuration (if you haven't)
4. Copy the Configuration ID
5. Add to Railway:
   ```
   FACEBOOK_CONFIG_ID=your_config_id
   ```
6. Redeploy

See: `FACEBOOK_CONFIG_ID_QUICK_FIX.md`

### Cause 5: Missing or Invalid Permissions

**Error in logs:** `insufficient_permissions` or `missing_permissions`

**Why it happens:**
- Required permissions not configured
- Permissions don't have Advanced Access

**Solution:**

1. Go to App Review → Permissions and Features
2. Request Advanced Access for:
   - **email**
   - **public_profile**
3. Should show green checkmark "Advanced Access"

See: `FACEBOOK_PERMISSIONS_FIX.md`

### Cause 6: HTTPS Required

**Error in logs:** `insecure_redirect_uri`

**Why it happens:**
- Using HTTP instead of HTTPS in production
- Facebook requires HTTPS for redirect URIs (except localhost)

**Solution:**

- Railway automatically provides HTTPS
- Make sure `APP_BASE_URL` starts with `https://`
- Check all redirect URIs use `https://`

**Exception:** localhost can use `http://` for testing:
```
http://localhost:3000/oauth/callback/facebook
```

### Cause 7: App Domain Mismatch

**Error in logs:** `domain_mismatch` or `app_domain_error`

**Why it happens:**
- Your redirect URI domain is not in "App Domains"

**Solution:**

1. Go to Settings → Basic
2. Scroll to **App Domains**
3. Add your domain WITHOUT `https://`:
   ```
   your-railway-domain.up.railway.app
   ```
4. Save changes

---

## Step-by-Step Debugging Process

### Phase 1: Capture the Error

1. **Open browser developer console** (F12)
2. Go to Network tab
3. Try Facebook login again
4. Look for failed requests
5. Check the error response

**OR**

1. **Check Railway logs** (recommended)
2. Find the OAuth callback request
3. Look for error messages

### Phase 2: Identify the Error Code

Common error codes:

| Error Code | Meaning | Fix |
|------------|---------|-----|
| `redirect_uri_mismatch` | Redirect URI doesn't match | Add exact URI to Facebook settings |
| `invalid_client` | Wrong App ID or Secret | Check environment variables |
| `unauthorized_client` | Not authorized to use this app | Add yourself as tester |
| `access_denied` | User denied permission | Normal if user clicks "Cancel" |
| `invalid_request` | Malformed request | Check config_id if using FB Login for Business |
| `invalid_scope` | Invalid permission requested | Check scope parameter |

### Phase 3: Apply the Fix

Based on the error code, apply the corresponding solution from above.

### Phase 4: Test Again

1. Clear browser cache and cookies (for Facebook)
2. Try the OAuth flow again
3. Check if the error is resolved

---

## Manual Testing Steps

### Test 1: Verify OAuth URL is Correct

Generate an OAuth URL and check it manually:

**Expected format:**
```
https://www.facebook.com/v18.0/dialog/oauth?
  client_id=YOUR_APP_ID&
  redirect_uri=https%3A%2F%2Fyour-domain.com%2Foauth%2Fcallback%2Ffacebook&
  scope=public_profile&
  response_type=code&
  state=...&
  config_id=... (if using FB Login for Business)
```

**Check:**
- ✅ `client_id` matches your Facebook App ID
- ✅ `redirect_uri` is URL-encoded
- ✅ `redirect_uri` matches Facebook settings EXACTLY
- ✅ `scope` includes `public_profile` (and optionally `email`)
- ✅ `config_id` is present if using FB Login for Business

### Test 2: Test Redirect URI Directly

Try accessing your callback URL directly:

```
https://your-railway-domain.up.railway.app/oauth/callback/facebook?code=test&state=test
```

**Expected result:**
- Should NOT return 404
- Should redirect to your app (might show error about invalid code, which is OK)
- Should NOT show "Cannot GET /oauth/callback/facebook"

### Test 3: Verify Environment Variables

Create a test endpoint to check environment variables:

```javascript
// Temporary test endpoint (REMOVE AFTER TESTING!)
router.get('/test-facebook-config', (req, res) => {
  res.json({
    hasClientId: !!process.env.FACEBOOK_CLIENT_ID,
    hasClientSecret: !!process.env.FACEBOOK_CLIENT_SECRET,
    hasConfigId: !!process.env.FACEBOOK_CONFIG_ID,
    appBaseUrl: process.env.APP_BASE_URL,
    clientIdLength: process.env.FACEBOOK_CLIENT_ID?.length || 0,
  });
});
```

Access: `https://your-domain.com/api/social-auth/test-facebook-config`

**Expected result:**
```json
{
  "hasClientId": true,
  "hasClientSecret": true,
  "hasConfigId": true,
  "appBaseUrl": "https://your-railway-domain.up.railway.app",
  "clientIdLength": 16
}
```

**Note:** Delete this endpoint after testing (security risk)!

---

## Advanced Debugging

### Enable Detailed Logging

Add this to your `server/routes/socialAuthRoutes.js` temporarily:

```javascript
router.get('/oauth/:platform/url', verifyToken, (req, res) => {
  const { platform } = req.params;
  const config = SOCIAL_CONFIG[platform];

  // ... existing code ...

  // ADD THIS LOGGING:
  console.log('=== OAUTH DEBUG ===');
  console.log('Platform:', platform);
  console.log('Client ID:', config.clientId?.substring(0, 10) + '...');
  console.log('Config ID:', process.env.FACEBOOK_CONFIG_ID);
  console.log('Redirect URI:', redirectUri);
  console.log('Auth URL:', authUrl);
  console.log('===================');

  res.json({
    success: true,
    authUrl,
    platform
  });
});
```

Check Railway logs for these debug messages.

### Test with Graph API Explorer

1. Go to: https://developers.facebook.com/tools/explorer/
2. Select your BuzzIt app
3. Click "Generate Access Token"
4. Try to get a token with `email` and `public_profile` permissions
5. If this fails, the issue is with your app configuration, not your code

---

## Quick Fix Checklist

Before continuing, verify ALL of these:

- [ ] Facebook App ID is correct in Railway
- [ ] Facebook App Secret is correct in Railway
- [ ] APP_BASE_URL is set in Railway with https://
- [ ] Redirect URIs are added to Facebook settings
- [ ] Redirect URIs match EXACTLY (check trailing slashes)
- [ ] App Domains includes your Railway domain
- [ ] Client OAuth Login is enabled
- [ ] You're added as a developer/tester (if app in Development mode)
- [ ] Permissions (email, public_profile) have Advanced Access
- [ ] Config ID is set (if using FB Login for Business)
- [ ] Server is redeployed after environment variable changes

---

## Still Not Working?

### Get More Information

1. **Check exact error from Facebook:**
   - Look at the URL when error page appears
   - Look for `error` and `error_description` parameters
   - Example: `?error=redirect_uri_mismatch&error_description=...`

2. **Check Railway logs in detail:**
   ```bash
   # Search for these patterns:
   - "OAuth facebook callback error"
   - "error"
   - "failed"
   - "invalid"
   ```

3. **Test with curl:**
   ```bash
   curl "https://your-domain.com/api/social-auth/oauth/facebook/url" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

### Contact Support

If you've tried everything and it still doesn't work:

1. **Gather this information:**
   - Exact error message from Facebook
   - Server logs from Railway
   - Screenshot of Facebook App settings
   - Your OAuth URL (with client_id censored)

2. **Check Facebook Developer Community:**
   - https://developers.facebook.com/community/

3. **Verify your app isn't restricted:**
   - Check for warnings in Facebook App Dashboard
   - Look for any restrictions or blocks

---

## Summary

**Most common fixes (95% of cases):**

1. ✅ Add redirect URIs to Facebook settings
2. ✅ Add yourself as a tester (if app in Development mode)
3. ✅ Set environment variables correctly in Railway
4. ✅ Add config_id (if using FB Login for Business)
5. ✅ Request Advanced Access for permissions

**Start here:** Check your Railway logs first - they'll tell you exactly what the error is!

---

## Resources

- **OAuth Debugging**: https://developers.facebook.com/docs/facebook-login/guides/access-tokens/debugging
- **Common Errors**: https://developers.facebook.com/docs/facebook-login/guides/access-tokens/errors
- **App Review**: https://developers.facebook.com/docs/app-review
